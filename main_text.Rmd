---
title: "Untitled"
author: "Elena Chechik"
date: "6/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r пакеты, include=FALSE}
library(plyr)
library(ggforce)
library(knitr)
library(kableExtra)
library(dplyr)
library(readr)
library(fBasics)
library(formattable)
library(plotrix)
library(tidyr)
library(readxl)
library(stringr)
library(ggplot2)
library(tidyverse)
library(plotly)
library(patchwork)
library(ggsignif)
library(concaveman)
library(DT)
```

```{r данные}
finance_table_all <- read_excel("data/finance_table_all.xlsx")
df <- finance_table_all
nm <- colnames(finance_table_all)
nm1 <- nm[4:51]

df[nm1] <- lapply(df[nm1], function(x) gsub(",", ".", x))
df[nm1] <- lapply(df[nm1], function(x) as.numeric(gsub("[[:space:]]", "", x)))

merged_final <- df %>% 
  dplyr::filter(code_010_100_totalEndYear > 0) %>% 
  replace(is.na(.), 0) %>% 
  mutate(short_name = gsub("\"", "_", agencyName),
                      short_name = gsub("^.*\\ _", "", short_name),
                      short_name = gsub("_", "", short_name))

#availableMeansEndYear - Приносящая доход деятельность
#budgetActivityEndYear - Деятельность с целевыми средствами
#incomeActivityEndYear -Деятельность по государственному заданию
#totalEndYear - Итого
#<br/><br/>

# CЕМЕЙСТВА

finance_table_all <- read_excel("data/finance_table_all.xlsx")

df <- finance_table_all
nm <- colnames(finance_table_all)
nm1 <- nm[4:51]

df[nm1] <- lapply(df[nm1], function(x) gsub(",", ".", x))
df[nm1] <- lapply(df[nm1], function(x) as.numeric(gsub("[[:space:]]", "", x)))

merged_final <- df %>% 
  dplyr::filter(code_010_100_totalEndYear > 0) %>% 
  replace(is.na(.), 0)

rm(df,finance_table_all)
rm(nm,nm1)

additional_variables_coded <- read_excel("data/additional_variables_coded.xlsx")
additional_variables_coded <-  additional_variables_coded %>% mutate(family_profile2 = family_profile)
additional_variables_coded$family_profile <- car::recode(additional_variables_coded$family_profile,"'1'='Аграрные';
                           '2'='Культуры и искусств';
                           '3'='Технические';
                           '4'='Социальные и гуманитарные';
                           '5'='Медицинские';
                           '6'='Педагогические';
                           '7'='Классические';
                           '8'='Силовые и спортивные';
                           '9'='Муниципальные';
                           '10'='Частные'
                           ")
additional_variables_coded <- additional_variables_coded %>% select(1,5,14)

agencies_with_inn <- read_excel("data/agencies_with_inn.xlsx")
agencies_with_inn <- agencies_with_inn %>% select(1,3,4)

merged <- left_join(merged_final, agencies_with_inn, by = "agencyId")
#colnames(merged_final)
#colnames(agencies_with_inn)

merged_final <- left_join(merged, additional_variables_coded, by = c("id_monitoring"="id"))
#summary(merged_final)
#f <- merged_final %>% filter(is.na(family_profile2)) %>% select(3,53)
#write.csv(f  , "no_type_uni.csv", fileEncoding = "UTF-8")
#colnames(merged)
#colnames(additional_variables_coded)
merged_final <- merged_final %>% mutate(family_profile2 = 
                               case_when(agencyId == 280558 | agencyId ==  280252 ~ 7,
                                         agencyId == 284459 | agencyId ==  531526 ~ 3,
                                         agencyId == 285206 | agencyId ==  284151 ~ 9,
                                         agencyId == 144722 ~ 4,
                                         TRUE   ~  family_profile2)
                             ) %>% 
  mutate(family_profile = case_when(family_profile2 == "7" ~ "Классические",
                                    family_profile2 == "3" ~ "Технические",
                                    family_profile2 == "9" ~ "Муниципальные", 
                                    family_profile2 == "4" ~ "Социальные и гуманитарные",
                                    TRUE   ~  family_profile)
         )


merged_final <- merged_final %>%  mutate(short_name = gsub("\"", "_", agencyName),
                      short_name = gsub("^.*\\ _", "", short_name),
                      short_name = gsub("_", "", short_name))

# РЕГИОН

regions <- read_csv("data/regions.csv")
regions <- regions %>% select(-1)

merged_final <- left_join(merged_final, regions, by = c("id_monitoring"="id"))

merged_final[merged_final$short_name == "ФЕДЕРАЛЬНОЕ ГОСУДАРСТВЕННОЕ АВТОНОМНОЕ ОБРАЗОВАТЕЛЬНОЕ УЧРЕЖДЕНИЕ ВЫСШЕГО ОБРАЗОВАНИЯ ПЕРВЫЙ МОСКОВСКИЙ ГОСУДАРСТВЕННЫЙ МЕДИЦИНСКИЙ УНИВЕРСИТЕТ ИМЕНИ И.М. СЕЧЕНОВА МИНИСТЕРСТВА ЗДРАВООХРАНЕНИЯ РОССИЙСКОЙ ФЕДЕРАЦИИ (СЕЧЕНОВСКИЙ УНИВЕРСИТЕТ)", "short_name"] <- "МОСКОВСКИЙ ГОСУДАРСТВЕННЫЙ МЕДИЦИНСКИЙ УНИВЕРСИТЕТ ИМЕНИ И.М. СЕЧЕНОВА"

```

#### Таблица 3. Описательные статистики доходов вузов {-}

```{r}

t3 <- merged_final %>% 
  dplyr::filter(agencyId != 154506 & agencyId != 164804) %>%
  mutate(inc_sh_gov = 100*(code_010_100_budgetActivityEndYear + code_010_100_incomeActivityEndYear)/code_010_100_totalEndYear,
                 inc_sh_mark = 100*code_010_100_availableMeansEndYear/code_010_100_totalEndYear,
                 cos_sh_gov = 100*(code_150_200_budgetActivityEndYear + code_150_200_incomeActivityEndYear)/code_150_200_totalEndYear,
                 cos_sh_mark = 100*code_150_200_availableMeansEndYear/code_150_200_totalEndYear) %>% 
  select(2,inc_sh_gov, inc_sh_mark, cos_sh_gov, cos_sh_mark) 

t3 <-   t3 %>%  select(-1)
  
colnames(t3)[2] <- "Доходы от приносящ. доход деятельн." 
colnames(t3)[1] <- "Доходы от бюджетов всех уровней"
colnames(t3)[4] <- "Расходы за счет приносящ. доход деятельн." 
colnames(t3)[3] <- "Расходы за счет бюджетов всех уровней"

J <- basicStats(t3)
J <- data.frame(t(J))

J <- formattable(J, digits = 2) %>% select(1:8)
#write.csv(J, "описательные_статистики.csv", fileEncoding = "UTF-8")
J
```

#### Рис. 1. Гистограммы распределения доходов вузов, завязанных на доходах населения и фирм {-}

```{r}

r1 <- merged_final %>% dplyr::filter(agencyId != 154506) %>% 
  mutate(inc_sh_mark = 100*code_040_130_availableMeansEndYear/code_010_100_totalEndYear) %>% select(agencyId,  inc_sh_mark) %>%
gather(key=agencyId, value=Value)  

f <- r1 %>% ggplot(aes(Value, fill = agencyId)) +
  geom_histogram(position = "identity", alpha = 0.7) +
  geom_vline(aes(xintercept = mean(Value)),col='red',size=0.6, linetype = 5)+
  labs(
    x = "Доходы от платных услуг (в % от общих доходов вуза)",
    y = "Число вузов", 
    fill = NULL
  )  + theme_bw()+
  theme(legend.position = 'none' )
f + geom_text(aes(x=42, y=40,label='mean = 33%'), size=3.5)

```


#### Таблица 4. Топ-10 вузов с самой большой долей доходов от оказания платных услуг населению и фирмам {-}

```{r}

#firstup <- function(x) {
#  substr(x, 1, 1) <- toupper(substr(x, 1, 1))
#  x
#}

t4 <- merged_final %>% dplyr::filter(agencyId != 154506) %>%
  mutate(inc_sh_mark = 100*code_040_130_availableMeansEndYear/code_010_100_totalEndYear) %>% 
  select(short_name,inc_sh_mark) %>% arrange(desc(inc_sh_mark)) #%>% top_n(10,inc_sh_mark)
  #mutate(short_name = firstup(tolower(short_name)))

colnames(t4)[1] <- "Вуз" 
colnames(t4)[2] <- "Доходы от платных услуг, %" 

#knitr::kable(t2 , booktabs = T, digits = 2) %>%
# kable_styling(full_width = F) #%>% 
#  row_spec(which(t2$family_profile2 > 8), background = "#e6e6ff")

f <- datatable(t4)
formatRound(f, columns=c('Доходы от платных услуг, %'), digits=0, interval = 0,
  mark = "")

```


#### Таблица 4а. Топ-10 вузов по доходам от услуг населению и фирмам (в рублях) с указанием какую долю составляют эти доходы от общих {-}

```{r}
t4a <- merged_final %>% 
  mutate(
    budg = (code_040_130_incomeActivityEndYear + code_040_130_budgetActivityEndYear)/1000000,
    sh_mark_tot = 100*code_040_130_availableMeansEndYear/code_010_100_totalEndYear,
    tot = code_010_100_totalEndYear/1000000,
    code_040_130_availableMeansEndYear = code_040_130_availableMeansEndYear/1000000) %>% 
  select(short_name, code_040_130_availableMeansEndYear, sh_mark_tot) %>%
  arrange(desc(code_040_130_availableMeansEndYear))

colnames(t4a)[1] <- "Вуз" 
colnames(t4a)[2] <- "млн руб" 
colnames(t4a)[3] <- "% от общих доходов" 

sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Вуз'),
      th(colspan = 2, 'Доходы от услуг населению и фирмам')
    ),
    tr(
      lapply(c('млн руб', '% от общих доходов'), th)
    )
  )
))

f <- datatable(t4a, container = sketch, rownames = FALSE)
formatRound(f, columns=c('млн руб', '% от общих доходов'), digits=0, interval = 0,
  mark = "")

#knitr::kable(t2 , booktabs = T, digits = 1) %>%
#column_spec(1, bold = T) %>%
# kable_styling(full_width = F, font_size=13)  %>% 
#  add_header_above(c(" ","Доходы от услуг населению и фирмам" = 2))
```

#### Рис. 1а. Связь доли доходов от платных услуг с абсолютным их выражением в рублях {-}

```{r}
r1a <- merged_final %>% 
  mutate(budg = code_040_130_incomeActivityEndYear + code_040_130_budgetActivityEndYear,
         sh_mark_tot = 100*code_040_130_availableMeansEndYear/code_010_100_totalEndYear,
         tot = code_010_100_totalEndYear) %>% 
  select(short_name, code_040_130_availableMeansEndYear, budg, sh_mark_tot, tot, agencyId, family_profile)

colnames(r1a)[1] <- "univ" 
colnames(r1a)[2] <- "mark" 

#t2 <- formattable(t2)
#as.datatable(t2)

r1a %>% dplyr::filter(agencyId != 154506) %>% 
ggplot(aes(sh_mark_tot, mark)) + geom_point() +
 scale_y_continuous(trans='log10') +
 geom_smooth(method = "lm", se = FALSE) +
  labs(
    y = "Доход от платных услуг в рублях (логарифм)",
    x = "Доходы от платных услуг в % от общих доходов вуза", 
    fill = NULL)  + 
  theme_bw()+
  theme(legend.position = 'none' )
```

#### Рис. 1г. Связь доли доходов от платных услуг и доходов от бюджетов всех уровней (в рублях) по группам регионов {-}

```{r}

r1g <- merged_final %>% 
  mutate(budg = code_040_130_incomeActivityEndYear + code_040_130_budgetActivityEndYear,
         budg_good =  code_010_100_incomeActivityEndYear + code_010_100_budgetActivityEndYear,
         sh_mark_tot = 100*code_040_130_availableMeansEndYear/code_010_100_totalEndYear,
         tot = code_010_100_totalEndYear, 
         capital = case_when(region_2017 == "г.Москва" | region_2017 == "г.Санкт-Петербург" ~ "Столичные",
                                         TRUE   ~  "Региональные")) %>% 
  select(short_name, code_040_130_availableMeansEndYear, sh_mark_tot, region_2017,capital,budg_good, family_profile, agencyId)

colnames(r1g)[1] <- "univ" 
colnames(r1g)[2] <- "mark" 

r1g %>% dplyr::filter(agencyId != 154506) %>% 
ggplot(aes(sh_mark_tot, budg_good, colour = capital)) + geom_point(size = 2) +
scale_y_continuous(trans='log10') +
geom_smooth(method = "lm", se = FALSE, size = 0.7) +
  labs(
    y = "Деньги из бюджетов всех уровней в рублях (логарифм)",
    x = "Доходы от платных услуг в % от общих доходов вуза", 
    fill = NULL)  + 
  theme_bw()+
  theme(legend.position = 'bottom',
        legend.title = element_blank())

```

#### Рис. 4. Доходы от платных услуг населению и фирмам по типам вузов {-}

```{r}
r4 <- merged_final %>% dplyr::filter(agencyId != 154506) %>% 
  mutate(inc_sh_mark = 100*code_040_130_availableMeansEndYear/code_010_100_totalEndYear) %>% 
  select(short_name,inc_sh_mark, family_profile) %>% group_by(family_profile) %>% summarise(
    uni_count = length(short_name), 
 #  median = median(inc_sh_mark), 
    mean = mean(inc_sh_mark)) 

r4 %>% 
ggplot(aes(x=reorder(family_profile, mean), 
                       y=mean, 
                       fill = family_profile)) +
  geom_bar(stat="identity")+ coord_flip() + 
  scale_fill_manual(values = c("grey", "grey", "grey","red","grey", "grey", "grey","red","grey")) + geom_hline(yintercept=33, linetype="dashed")+
  geom_text(aes(x=1, y=38,label='mean = 33%'), size=3.5) +
  geom_text(aes(label=digits(mean,0)),hjust = 1.5, vjust=0.5, size=4)+
  labs(
    y = "Доходы от платных услуг (в % от общих доходов вуза)",
    fill = NULL
  ) +
  theme_bw() +
  theme(legend.position = 'none',
        axis.title.y = element_blank()) 

```


#### Таблица 5. Топ-10 регионов с самой большой долей доходов от оказания платных услуг населению и фирмам {-}

```{r}
t5 <- merged_final %>% dplyr::filter(agencyId != 154506) %>% 
  mutate(inc_sh_mark = 100*code_040_130_availableMeansEndYear/code_010_100_totalEndYear) %>% 
  select(short_name,inc_sh_mark, family_profile, region_2017) %>% 
  group_by(region_2017) %>% 
  summarise(mean = mean(inc_sh_mark),mediana = median(inc_sh_mark), uni_count = length(short_name)) %>% arrange(desc(mean)) # %>% top_n(10, mean)

colnames(t5)[4] <- "Кол-во вузов" 
colnames(t5)[2] <- "Средняя доля доходов (в %)" 
colnames(t5)[3] <- "Медиана (в %)" 
colnames(t5)[1] <- "Регионы"

f <- datatable(t5)
formatRound(f, columns=c(2:4), digits=0, interval = 0, mark = "")

#knitr::kable(t2 , booktabs = T, digits = 3) %>%
 #kable_styling(full_width = F) 
```


#### Рис. 5. Связь числа вузов в регионе и доли доходов от платных услуг в этих вузах (без Москвы и Спб) {-}

```{r}

r5 <- merged_final %>% dplyr::filter(agencyId != 154506) %>% 
  mutate(
    inc_sh_mark = 100*code_040_130_availableMeansEndYear/code_010_100_totalEndYear) %>% 
  select(short_name,inc_sh_mark, family_profile, region_2017) %>% 
  group_by(region_2017) %>% 
  summarise(
    mean = mean(inc_sh_mark),
    mediana = median(inc_sh_mark), 
    uni_count = length(short_name))

r5 %>% filter(uni_count<20) %>% 
  ggplot() + geom_point(aes(x = mean, y = uni_count)) + geom_vline(xintercept=33, linetype="dashed", color = "red")+
  geom_text(aes(x=35, y=11,label='mean = 33%'), size=3.5) +
  labs(
    x = "Доходы от платных услуг (в % от общих доходов вуза)",
    y = "Число гос вузов в регионе", 
    fill = NULL
  )  + theme_bw()+
  theme(legend.position = 'none' )

```

#### Рис. 6. Отношение расходов от приносящей доход деятельности к доходам от приносящей доход деятельности: гистограмма распределения {-}

```{r}
r5 <- merged_final %>% 
  dplyr::filter(agencyId != 164804 & agencyId != 168032) %>% 
  mutate(
    inc_sh_mark = 100*code_150_200_availableMeansEndYear/code_010_100_availableMeansEndYear) %>% 
  select(agencyId,inc_sh_mark) %>% 
  gather(key=agencyId, value=Value)  

f <- r5 %>% ggplot(aes(Value, fill = agencyId)) +
  geom_histogram(position = "identity", alpha = 0.7) +
  geom_vline(aes(xintercept = mean(Value)),col='red',size=0.6, linetype = 5)+
  labs(
    x = "Отсношение расходов от принос. доход деят. к доходам от принос. доход деят.",
    y = "Число вузов", 
    fill = NULL
  )  + theme_bw()+
  theme(legend.position = 'none' )
f + geom_text(aes(x=120, y=115,label='mean = 98%'), size=3.5) #+
#  geom_segment(aes(x = 50, y = 30, xend = 0, yend = 30),
 #                 arrow = arrow(length = unit(0.5, "cm")))
```

#### Рис. 7. Гистограмма распределения расходов, финансируемых приносящей доход деятельностью {-}

```{r}
r7 <- merged_final %>% mutate(cos_sh_wage = 100*code_160_210_availableMeansEndYear/code_150_200_availableMeansEndYear,
                      cos_sh_rab_usl = 100*code_170_220_availableMeansEndYear/code_150_200_availableMeansEndYear,
                     cos_sh_ostalnoe =  
                       100*(code_190_230_availableMeansEndYear+
                              code_210_240_availableMeansEndYear+
                              code_230_250_availableMeansEndYear+
                              code_240_260_availableMeansEndYear+
                              code_250_290_availableMeansEndYear+
                              code_260_270_availableMeansEndYear)/code_150_200_availableMeansEndYear) %>% 
  
  select(2,cos_sh_wage, cos_sh_rab_usl,cos_sh_ostalnoe) %>% 
  mutate(inc = cos_sh_wage+ cos_sh_rab_usl++cos_sh_ostalnoe) %>% 
  arrange(desc(cos_sh_ostalnoe)) %>% dplyr::filter(cos_sh_wage != "NaN")

#t5b <- formattable(t5b)
#as.datatable(t5b)

r7 <- r7 %>% 
  #dplyr::filter(cos_sh_prochee > 0) %>% 
  select(agencyId,cos_sh_wage, cos_sh_rab_usl,cos_sh_ostalnoe) %>% 
  gather(key=agencyId, value=Value, cos_sh_wage, cos_sh_rab_usl,cos_sh_ostalnoe) %>% 
  mutate(agencyId = case_when(agencyId == "cos_sh_wage" ~ "оплата труда",
                              agencyId == "cos_sh_rab_usl" ~ "оплата работ (услуг)",
                              TRUE   ~  "прочее")) 

mu <- ddply(r7, "agencyId", summarise, grp.mean=mean(Value))

r7 %>% 
  ggplot(aes(Value, fill = agencyId)) +
  geom_histogram(position = "identity", alpha = 0.7) +
  geom_vline(data=mu, aes(xintercept=grp.mean, fill = agencyId),
             linetype="dashed")+
  scale_color_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9"))+
  geom_text(aes(y=55, x=36,label='mean = 26%'), size=3.5, color = "#999999")+
    geom_text(aes(y=45, x=67,label='mean = 57%'), size=3.5, color = "#E69F00")+
      geom_text(aes(y=75, x=26,label='mean = 17%'), size=3.5, color = "#56B4E9")+
   labs(
    x = "Доли трех типов расходов (в %)",
    y = "Число вузов", 
    fill = NULL
  ) +
  theme_bw() 
```

Жопа

#### Таблица. 7. Расходы на оплату труда, финансируемые за счет денег студентов и фирм {-}

```{r}
t_base <- merged_final %>% 
  dplyr::filter(agencyId != 183965 & agencyId != 164804) %>% 
  mutate(all_inc = code_010_100_availableMeansEndYear/1000000, 
         mark_inc = code_040_130_availableMeansEndYear/1000000, 
         wage = code_160_210_availableMeansEndYear/1000000,
         dang = all_inc - mark_inc - wage,
         all_w = code_160_210_totalEndYear/1000000,
         all_cost = 100*code_160_210_totalEndYear/code_150_200_totalEndYear) %>% 
  dplyr::filter(dang < 0)   %>%
  mutate(dang = abs(dang),
         dang_sh = 100*dang/all_w,
         ostat = (code_150_200_totalEndYear-code_160_210_totalEndYear)/1000000) %>% 
  select(agencyId,
         all_inc, 
         mark_inc, 
         wage,
         dang,
         all_w,
         dang_sh,
         short_name,
         all_cost, 
         family_profile,
         region_2017,
         ostat
    )
t_base %>% select(short_name, all_inc, mark_inc, wage, all_w, dang, dang_sh) %>%  datatable ()

```

```{r}
t7 <- t_base %>% 
  select(short_name, all_w, dang, dang_sh) %>% arrange(desc(dang_sh))
colnames(t7)[4] <- "(в % от общих)" 
colnames(t7)[3] <- "(в млн. руб)" 
#colnames(t3)[3] <- "Расходы на оплату труда только за счет присносящ. дох. деятельн." 
colnames(t7)[2] <- "Общие  (в млн. руб)" 
colnames(t7)[1] <- "Вуз"

#knitr::kable(t3 , booktabs = T, digits = 0) %>%
# kable_styling(full_width = F, c("bordered")) %>% 
#  column_spec(1, bold = T) %>% 
#  column_spec(3, width = "8em") %>% 
#  column_spec(4, width = "9em", background = " #e6f2ff") %>% 
#  column_spec(2, width = "8em") %>% 
#  add_header_above(c(" ", " ", "Финансируемые за счет студентов и фирм" = 2)) %>%
#  add_header_above(c(" ", "Расходы на оплату труда" = 3))

sketch = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(style="border-bottom:hidden", colspan = 1, ''),
      th(colspan = 3, 'Расходы на оплату труда')
      )
    ,
    tr(
      th(style="border-bottom:hidden",colspan = 1, ''),
      th(style="border-bottom:hidden",colspan = 1, ''),
      th(colspan = 2, 'Финансируемые за счет студентов и фирм')
      ),
    tr(
      th(colspan = 1, 'Вуз'),
      th(colspan = 1, 'Общие (в млн. руб)'),
      th(colspan = 1, '(в млн. руб)'),
      th(colspan = 1, '(в % от общих)')
    )
  )
))

f <- datatable(t7, rownames = FALSE, container = sketch)
formatRound(f, columns=c(2:4), digits=0, interval = 0,
  mark = "")

```

#### Таблица. 8. Топ вузов с самыми большими расходами на оплату труда из денег студентов и фирм при самой маленькой величине всех остальных расходов {-}

```{r}

t8 <- t_base %>% 
  mutate(sh = 100*ostat/dang) %>% 
  select(short_name, dang, ostat, sh) %>% #filter(sh>=100) %>% 
  arrange(sh)

colnames(t8)[1] <- "Вуз" 
colnames(t8)[3] <- "Все остальные расходы из всех источников кроме расходов на оплату труда (млн руб) [3]"
colnames(t8)[2] <- "Оплата труда, финансируемая студентами и фирмами (млн руб) [2]"
colnames(t8)[4] <- "Доля [3] к [2] (%)"
 
#kable(t2_i, booktabs = T, digits = 0) %>%
#  kable_styling(full_width = F, c("bordered")) %>% 
#  column_spec(1, bold = T) %>% 
 # column_spec(2, width = "8em") %>% 
 # column_spec(3, width = "11em") %>% 
#  column_spec(4, width = "5em", background = "#f2e6ff") 

f <- datatable(t8)
formatRound(f, columns=c(2:4), digits=0, interval = 0,
  mark = "")

```

#### Рис. 9. Расходы на оплату труда из денег студентов и фирм к величине всех остальных расходов: семейства {-}

```{r}
t_base %>% 
 #dplyr::filter(family_profile == "Социальные и гуманитарные") %>%
  dplyr::filter(ostat<2000 & dang<2500) %>%
ggplot(aes(ostat, dang, colour = family_profile)) + geom_point(size = 2) +
geom_segment(aes(x = 0, y = 0, xend = 2000, yend = 2000), linetype="dashed", 
                color = "red", size=0.5) +
  facet_wrap(~family_profile, nrow = 3)  +
#scale_y_continuous(trans='log10') +
#scale_x_continuous(trans='log10') +
#geom_smooth(method = "lm", se = FALSE, size = 0.7) +
  labs(
    y = "Оплата труда, финансируемая студентами и фирмами (млн руб)",
    x = "Все остальные расходы из всех источников кроме расходов на оплату труда (млн руб)",
    fill = NULL)  + 
  theme_bw() +
  theme(legend.position = 'none',
        legend.title = element_blank())
```
